<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Step by step guide</title>

<script src="site_libs/header-attrs-2.21/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/readable.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>









<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark the anchor link active (and if it's in a dropdown, also mark that active)
  var dropdown = menuAnchor.closest('li.dropdown');
  if (window.bootstrap) { // Bootstrap 4+
    menuAnchor.addClass('active');
    dropdown.find('> .dropdown-toggle').addClass('active');
  } else { // Bootstrap 3
    menuAnchor.parent().addClass('active');
    dropdown.addClass('active');
  }

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before, .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "\e259";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "\e258";
  font-family: 'Glyphicons Halflings';
  border: none;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">APD R-Ratepol workshop</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="workshop_info.html">Workshop Information</a>
</li>
<li>
  <a href="step_by_step_guide.html">A step-by-step guide</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">



<h1 class="title toc-ignore">Step by step guide</h1>

</div>


<p>This workflow should show full strength of <em>RRatepol package</em>
and serve as step by step guidance starting from downloading dataset
from Neotoma, building age-depth models, to estimating rate-of-change
using age uncertainty.</p>
<p>:warning: <strong>This workflow is only meant as example</strong>:
There are several additional steps for data reparation which should be
done to really use the data from Neotoma!</p>
<div id="install-packages" class="section level2">
<h2>Install packages</h2>
<p>Make a list of packages needed to from CRAN</p>
<pre class="r"><code>package_list &lt;-
  c(
    &quot;tidyverse&quot;, # general data wrangling and visualisation
    &quot;pander&quot;, # nice tables
    &quot;Bchron&quot;, # age-depth modeling
    &quot;janitor&quot;, # string cleaning
    &quot;remotes&quot; # installing packages from GitHub
  )</code></pre>
<p>Install all packages from CRAN using <code>{renv}</code> package</p>
<pre class="r"><code>lapply(
  package_list, renv::use
)</code></pre>
<p>Install packages from GitHub</p>
<pre class="r"><code># Install R-Ratepol
remotes::install_github(&quot;HOPE-UIB-BIO/R-Ratepol-package&quot;)

# Install neotoma2
remotes::install_github(&quot;NeotomaDB/neotoma2&quot;)</code></pre>
</div>
<div id="attach-packages" class="section level2">
<h2>Attach packages</h2>
<pre class="r"><code>library(tidyverse) # general data wrangling and visualisation
library(pander) # nice tables
library(RRatepol) # rate-of-vegetation change
library(neotoma2) # obtain data from Neotoma database
library(Bchron) # age-depth modeling
library(janitor) # string cleaning</code></pre>
</div>
<div id="download-a-dataset-from-neotoma" class="section level2">
<h2>Download a dataset from Neotoma</h2>
<p>Here we have selected the <strong>XXX</strong> record.</p>
<pre class="r"><code>sel_dataset_download &lt;-
  neotoma2::get_downloads(52995)</code></pre>
</div>
<div id="prepare-the-pollen-counts" class="section level2">
<h2>Prepare the pollen counts</h2>
<pre class="r"><code># get samples
sel_counts &lt;-
  neotoma2::samples(sel_dataset_download)

# select only &quot;pollen&quot; taxa
sel_taxon_list_selected &lt;-
  neotoma2::taxa(sel_dataset_download) %&gt;%
  dplyr::filter(element == &quot;pollen&quot;) %&gt;%
  purrr::pluck(&quot;variablename&quot;)

# prepare taxa table
sel_counts_selected &lt;-
  sel_counts %&gt;%
  as.data.frame() %&gt;%
  dplyr::mutate(sample_id = as.character(sampleid)) %&gt;%
  tibble::as_tibble() %&gt;%
  dplyr::select(&quot;sample_id&quot;, &quot;value&quot;, &quot;variablename&quot;) %&gt;%
  # only include selected taxons
  dplyr::filter(
    variablename %in% sel_taxon_list_selected
  ) %&gt;%
  # tunr into wider format
  tidyr::pivot_wider(
    names_from = &quot;variablename&quot;,
    values_from = &quot;value&quot;,
    values_fill = 0
  ) %&gt;%
  # clean names
  janitor::clean_names()

head(sel_counts_selected)[, 1:5]</code></pre>
<table style="width:76%;">
<colgroup>
<col width="16%" />
<col width="12%" />
<col width="12%" />
<col width="16%" />
<col width="18%" />
</colgroup>
<thead>
<tr class="header">
<th align="center">sample_id</th>
<th align="center">montia</th>
<th align="center">acaena</th>
<th align="center">limosella</th>
<th align="center">ranunculus</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">538999</td>
<td align="center">2</td>
<td align="center">3</td>
<td align="center">4</td>
<td align="center">9</td>
</tr>
<tr class="even">
<td align="center">539004</td>
<td align="center">0</td>
<td align="center">6</td>
<td align="center">0</td>
<td align="center">1</td>
</tr>
<tr class="odd">
<td align="center">539000</td>
<td align="center">0</td>
<td align="center">1</td>
<td align="center">1</td>
<td align="center">1</td>
</tr>
<tr class="even">
<td align="center">539001</td>
<td align="center">0</td>
<td align="center">1</td>
<td align="center">4</td>
<td align="center">3</td>
</tr>
<tr class="odd">
<td align="center">539002</td>
<td align="center">0</td>
<td align="center">3</td>
<td align="center">0</td>
<td align="center">1</td>
</tr>
<tr class="even">
<td align="center">539003</td>
<td align="center">0</td>
<td align="center">6</td>
<td align="center">0</td>
<td align="center">3</td>
</tr>
</tbody>
</table>
<p>Here, we strongly advocate that attention should be paid to the
section of ecological ecological group, as well, as harmonisation of the
pollen taxa. However, that is not subject of this workflow.</p>
<p>We can now try to visualise the taxa per sample_id</p>
<pre class="r"><code>sel_counts_selected %&gt;%
  tibble::rowid_to_column(&quot;ID&quot;) %&gt;%
  tidyr::pivot_longer(
    cols = -c(sample_id, ID),
    names_to = &quot;taxa&quot;,
    values_to = &quot;n_grains&quot;
  ) %&gt;%
  ggplot2::ggplot(
    mapping = ggplot2::aes(
      x = ID,
      y = n_grains,
      fill = taxa
    ),
  ) +
  ggplot2::geom_bar(
    stat = &quot;identity&quot;,
    position = &quot;fill&quot;
  ) +
  ggplot2::labs(
    x = &quot;sample_id&quot;,
    y = &quot;proportion of pollen grains&quot;
  ) +
  ggplot2::theme(
    axis.text.x = ggplot2::element_blank(),
    legend.position = &quot;bottom&quot;
  )</code></pre>
<p><img
src="step_by_step_guide_files/figure-html/count_vis-1.png" /><!-- --></p>
</div>
<div id="preparation-of-the-levels" class="section level2">
<h2>Preparation of the levels</h2>
<div id="sample-depth" class="section level3">
<h3>Sample depth</h3>
<p>Extract depth for each level</p>
<pre class="r"><code>sel_level &lt;-
  neotoma2::samples(sel_dataset_download) %&gt;%
  tibble::as_tibble() %&gt;%
  dplyr::mutate(sample_id = as.character(sampleid)) %&gt;%
  dplyr::distinct(sample_id, depth) %&gt;%
  dplyr::relocate(sample_id)

head(sel_level)</code></pre>
<table style="width:28%;">
<colgroup>
<col width="16%" />
<col width="11%" />
</colgroup>
<thead>
<tr class="header">
<th align="center">sample_id</th>
<th align="center">depth</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">538999</td>
<td align="center">5</td>
</tr>
<tr class="even">
<td align="center">539004</td>
<td align="center">18</td>
</tr>
<tr class="odd">
<td align="center">539000</td>
<td align="center">28</td>
</tr>
<tr class="even">
<td align="center">539001</td>
<td align="center">38</td>
</tr>
<tr class="odd">
<td align="center">539002</td>
<td align="center">45</td>
</tr>
<tr class="even">
<td align="center">539003</td>
<td align="center">58</td>
</tr>
</tbody>
</table>
</div>
<div id="age-depth-modelling" class="section level3">
<h3>Age depth modelling</h3>
<p>We will recalculate new age-depth model ‘de novo’ using
<em>Bchron</em> package.</p>
<div id="prepare-chron.control-table-and-run-bchron"
class="section level4">
<h4>Prepare chron.control table and run Bchron</h4>
<p>Chrolonogy control table contains all the dates (mostly radiocarbon)
to create age-depth model.</p>
<p>Here we only present few of the important steps of preparation of
chron.control table. There are many more potential issues issues but
solving those is not the focus of this workflow.</p>
<pre class="r"><code># first get the chronologies and check which we want to use used
sel_chron_control_table_download &lt;-
  neotoma2::chroncontrols(sel_dataset_download)

print(sel_chron_control_table_download)</code></pre>
<table>
<caption>Table continues below</caption>
<colgroup>
<col width="11%" />
<col width="19%" />
<col width="10%" />
<col width="15%" />
<col width="20%" />
<col width="22%" />
</colgroup>
<thead>
<tr class="header">
<th align="center">siteid</th>
<th align="center">chronologyid</th>
<th align="center">depth</th>
<th align="center">thickness</th>
<th align="center">agelimitolder</th>
<th align="center">chroncontrolid</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">28408</td>
<td align="center">37707</td>
<td align="center">70</td>
<td align="center">10</td>
<td align="center">1455</td>
<td align="center">115792</td>
</tr>
<tr class="even">
<td align="center">28408</td>
<td align="center">37707</td>
<td align="center">345</td>
<td align="center">10</td>
<td align="center">5970</td>
<td align="center">115795</td>
</tr>
<tr class="odd">
<td align="center">28408</td>
<td align="center">37707</td>
<td align="center">172.5</td>
<td align="center">15</td>
<td align="center">4210</td>
<td align="center">115793</td>
</tr>
<tr class="even">
<td align="center">28408</td>
<td align="center">37707</td>
<td align="center">358</td>
<td align="center">10</td>
<td align="center">6060</td>
<td align="center">115796</td>
</tr>
<tr class="odd">
<td align="center">28408</td>
<td align="center">37707</td>
<td align="center">287.5</td>
<td align="center">15</td>
<td align="center">5759</td>
<td align="center">115794</td>
</tr>
</tbody>
</table>
<table style="width:76%;">
<colgroup>
<col width="25%" />
<col width="25%" />
<col width="26%" />
</colgroup>
<thead>
<tr class="header">
<th align="center">agelimityounger</th>
<th align="center">chroncontrolage</th>
<th align="center">chroncontroltype</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">1105</td>
<td align="center">1280</td>
<td align="center">Radiocarbon</td>
</tr>
<tr class="even">
<td align="center">5830</td>
<td align="center">5900</td>
<td align="center">Radiocarbon</td>
</tr>
<tr class="odd">
<td align="center">4070</td>
<td align="center">4140</td>
<td align="center">Radiocarbon</td>
</tr>
<tr class="even">
<td align="center">5920</td>
<td align="center">5990</td>
<td align="center">Radiocarbon</td>
</tr>
<tr class="odd">
<td align="center">5139</td>
<td align="center">5449</td>
<td align="center">Radiocarbon</td>
</tr>
</tbody>
</table>
<pre class="r"><code># prepare the table
sel_chron_control_table &lt;-
  sel_chron_control_table_download %&gt;%
  # here select the ID of oe of the chronology
  dplyr::filter(chronologyid == 37707) %&gt;%
  tibble::as_tibble() %&gt;%
  # here we calculate the error as the avarage as the agelimitolder and
  #   agelimityounger
  dplyr::mutate(
    error = round((agelimitolder - agelimityounger) / 2)
  ) %&gt;%
  # as Bchron cannot accept error of 0, we need to replace the value with 1
  dplyr::mutate(
    error = replace(error, error == 0, 1),
    error = ifelse(is.na(error), 1, error)
  ) %&gt;%
  # we need to specifify which calibration curve should be used for what point
  dplyr::mutate(
    curve = ifelse(as.data.frame(sel_dataset_download)[&quot;lat&quot;] &gt; 0, &quot;intcal20&quot;, &quot;shcal20&quot;),
    curve = ifelse(chroncontroltype != &quot;Radiocarbon&quot;, &quot;normal&quot;, curve)
  ) %&gt;%
  tibble::column_to_rownames(&quot;chroncontrolid&quot;) %&gt;%
  dplyr::arrange(depth) %&gt;%
  dplyr::select(
    chroncontrolage, error, depth, thickness, chroncontroltype, curve
  )

head(sel_chron_control_table)</code></pre>
<table>
<colgroup>
<col width="24%" />
<col width="10%" />
<col width="10%" />
<col width="16%" />
<col width="25%" />
<col width="13%" />
</colgroup>
<thead>
<tr class="header">
<th align="center">chroncontrolage</th>
<th align="center">error</th>
<th align="center">depth</th>
<th align="center">thickness</th>
<th align="center">chroncontroltype</th>
<th align="center">curve</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">1280</td>
<td align="center">175</td>
<td align="center">70</td>
<td align="center">10</td>
<td align="center">Radiocarbon</td>
<td align="center">shcal20</td>
</tr>
<tr class="even">
<td align="center">4140</td>
<td align="center">70</td>
<td align="center">172.5</td>
<td align="center">15</td>
<td align="center">Radiocarbon</td>
<td align="center">shcal20</td>
</tr>
<tr class="odd">
<td align="center">5449</td>
<td align="center">310</td>
<td align="center">287.5</td>
<td align="center">15</td>
<td align="center">Radiocarbon</td>
<td align="center">shcal20</td>
</tr>
<tr class="even">
<td align="center">5900</td>
<td align="center">70</td>
<td align="center">345</td>
<td align="center">10</td>
<td align="center">Radiocarbon</td>
<td align="center">shcal20</td>
</tr>
<tr class="odd">
<td align="center">5990</td>
<td align="center">70</td>
<td align="center">358</td>
<td align="center">10</td>
<td align="center">Radiocarbon</td>
<td align="center">shcal20</td>
</tr>
</tbody>
</table>
<p>In this toy example we will use only iteration multiplier
(<em>i_multiplier</em>) of 0.1 to reduce the computation time. However,
we strongly recommend to increase it to 5 for any normal age-depth model
construction.</p>
<pre class="r"><code>i_multiplier &lt;- 0.1 # increase to 5

# those are default values suggested by the bchron package
n_iteration_default &lt;- 10e3
n_burn_default &lt;- 2e3
n_thin_default &lt;- 8

# lets multiply them by our i_multiplier
n_iteration &lt;- n_iteration_default * i_multiplier
n_burn &lt;- n_burn_default * i_multiplier
n_thin &lt;- max(c(1, n_thin_default * i_multiplier))

# run bchron
sel_bchron &lt;-
  Bchron::Bchronology(
    ages = sel_chron_control_table$chroncontrolage,
    ageSds = sel_chron_control_table$error,
    positions = sel_chron_control_table$depth,
    calCurves = sel_chron_control_table$curve,
    positionThicknesses = sel_chron_control_table$thickness,
    iterations = n_iteration,
    burn = n_burn,
    thin = n_thin
  )</code></pre>
<p>Visualy check the age-depth models</p>
<pre class="r"><code>plot(sel_bchron)</code></pre>
<p><img
src="step_by_step_guide_files/figure-html/bchron_figure-1.png" /><!-- --></p>
</div>
<div id="predict-ages" class="section level4">
<h4>Predict ages</h4>
<p>Let’s firts extract posterion ages from the age-depth model
(i.e. possible ages)</p>
<pre class="r"><code>age_position &lt;-
  Bchron:::predict.BchronologyRun(object = sel_bchron, newPositions = sel_level$depth)

age_uncertainties &lt;-
  age_position %&gt;%
  as.data.frame() %&gt;%
  dplyr::mutate_all(., as.integer) %&gt;%
  as.matrix()

colnames(age_uncertainties) &lt;- sel_level$sample_id

head(age_uncertainties, n = 8)[, 1:8]</code></pre>
<table>
<colgroup>
<col width="12%" />
<col width="12%" />
<col width="12%" />
<col width="12%" />
<col width="12%" />
<col width="12%" />
<col width="12%" />
<col width="12%" />
</colgroup>
<thead>
<tr class="header">
<th align="center">538999</th>
<th align="center">539004</th>
<th align="center">539000</th>
<th align="center">539001</th>
<th align="center">539002</th>
<th align="center">539003</th>
<th align="center">539006</th>
<th align="center">539005</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">52</td>
<td align="center">137</td>
<td align="center">202</td>
<td align="center">266</td>
<td align="center">328</td>
<td align="center">452</td>
<td align="center">547</td>
<td align="center">1284</td>
</tr>
<tr class="even">
<td align="center">783</td>
<td align="center">846</td>
<td align="center">895</td>
<td align="center">943</td>
<td align="center">977</td>
<td align="center">1041</td>
<td align="center">1089</td>
<td align="center">1288</td>
</tr>
<tr class="odd">
<td align="center">656</td>
<td align="center">798</td>
<td align="center">908</td>
<td align="center">1018</td>
<td align="center">1095</td>
<td align="center">1238</td>
<td align="center">1348</td>
<td align="center">1749</td>
</tr>
<tr class="even">
<td align="center">334</td>
<td align="center">406</td>
<td align="center">649</td>
<td align="center">880</td>
<td align="center">987</td>
<td align="center">1186</td>
<td align="center">1339</td>
<td align="center">1711</td>
</tr>
<tr class="odd">
<td align="center">1235</td>
<td align="center">1262</td>
<td align="center">1283</td>
<td align="center">1304</td>
<td align="center">1318</td>
<td align="center">1345</td>
<td align="center">1366</td>
<td align="center">1751</td>
</tr>
<tr class="even">
<td align="center">588</td>
<td align="center">640</td>
<td align="center">681</td>
<td align="center">814</td>
<td align="center">935</td>
<td align="center">1161</td>
<td align="center">1335</td>
<td align="center">2595</td>
</tr>
<tr class="odd">
<td align="center">1138</td>
<td align="center">1184</td>
<td align="center">1220</td>
<td align="center">1256</td>
<td align="center">1281</td>
<td align="center">1327</td>
<td align="center">1363</td>
<td align="center">2097</td>
</tr>
<tr class="even">
<td align="center">819</td>
<td align="center">845</td>
<td align="center">875</td>
<td align="center">921</td>
<td align="center">952</td>
<td align="center">1010</td>
<td align="center">1074</td>
<td align="center">1717</td>
</tr>
</tbody>
</table>
<p>We can visualise those “possible ages”</p>
<pre class="r"><code>data_age_uncertainties &lt;-
  age_uncertainties %&gt;%
  as.data.frame() %&gt;%
  tibble::rowid_to_column(&quot;ID&quot;) %&gt;%
  tidyr::pivot_longer(
    cols = -ID,
    names_to = &quot;sample_id&quot;,
    values_to = &quot;age&quot;
  ) %&gt;%
  dplyr::left_join(
    sel_level,
    by = dplyr::join_by(sample_id)
  )</code></pre>
<p>Each line is a single potential age-depth result</p>
<pre class="r"><code>(
  fig_age_uncertainties &lt;-
    data_age_uncertainties %&gt;%
    ggplot2::ggplot(
      mapping = ggplot2::aes(
        x = age,
        y = depth
      )
    ) +
    ggplot2::geom_line(
      mapping = ggplot2::aes(
        group = ID
      ),
      alpha = 0.05,
      linewidth = 0.1
    )
)</code></pre>
<p><img
src="step_by_step_guide_files/figure-html/age_uncertainties_vis_lines-1.png" /><!-- --></p>
<p>We can visualise the result as range of the values, each line
represent one depth in our data</p>
<pre class="r"><code>data_age_uncertainties %&gt;%
  ggplot2::ggplot(
    mapping = ggplot2::aes(
      x = age,
      y = depth,
      group = depth
    )
  ) +
  ggplot2::geom_hline(
    yintercept = sel_level$depth,
    lty = 2,
    color = &quot;gray50&quot;
  ) +
  ggplot2::geom_boxplot()</code></pre>
<p><img
src="step_by_step_guide_files/figure-html/age_uncertainties_vis_boxplot-1.png" /><!-- --></p>
<p>Let’s take the median age of all possibilities as our default</p>
<pre class="r"><code>sel_level_predicted &lt;-
  sel_level %&gt;%
  dplyr::mutate(
    age = apply(
      age_uncertainties, 2,
      stats::quantile,
      probs = 0.5
    )
  )

head(sel_level_predicted)</code></pre>
<table style="width:39%;">
<colgroup>
<col width="16%" />
<col width="11%" />
<col width="11%" />
</colgroup>
<thead>
<tr class="header">
<th align="center">sample_id</th>
<th align="center">depth</th>
<th align="center">age</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">538999</td>
<td align="center">5</td>
<td align="center">608.5</td>
</tr>
<tr class="even">
<td align="center">539004</td>
<td align="center">18</td>
<td align="center">720</td>
</tr>
<tr class="odd">
<td align="center">539000</td>
<td align="center">28</td>
<td align="center">799</td>
</tr>
<tr class="even">
<td align="center">539001</td>
<td align="center">38</td>
<td align="center">871.5</td>
</tr>
<tr class="odd">
<td align="center">539002</td>
<td align="center">45</td>
<td align="center">928</td>
</tr>
<tr class="even">
<td align="center">539003</td>
<td align="center">58</td>
<td align="center">1040</td>
</tr>
</tbody>
</table>
<p>We can visualise that by drawing a red line</p>
<pre class="r"><code>fig_age_uncertainties +
  ggplot2::geom_point(
    data = sel_level_predicted,
    color = &quot;red&quot;,
    size = 3
  ) +
  ggplot2::geom_line(
    data = sel_level_predicted,
    color = &quot;red&quot;,
    size = 1
  )</code></pre>
<p><img
src="step_by_step_guide_files/figure-html/age_uncertainties_vis_median-1.png" /><!-- --></p>
</div>
</div>
<div id="visualisation-of-our-data" class="section level3">
<h3>Visualisation of our data</h3>
<p>Lets make a simple pollen diagram with proportions of pollen taxa</p>
<pre class="r"><code>sel_counts_selected %&gt;%
  tibble::column_to_rownames(&quot;sample_id&quot;) %&gt;%
  RRatepol:::fc_transfer_into_proportions() %&gt;%
  tibble::rownames_to_column(&quot;sample_id&quot;) %&gt;%
  dplyr::inner_join(
    sel_level_predicted,
    by = dplyr::join_by(sample_id)
  ) %&gt;%
  tidyr::pivot_longer(
    cols = -c(sample_id, depth, age),
    names_to = &quot;taxa&quot;,
    values_to = &quot;proportion_of_grains&quot;
  ) %&gt;%
  ggplot2::ggplot(
    mapping = ggplot2::aes(
      y = age,
      x = proportion_of_grains,
      xmax = proportion_of_grains,
      xmin = 0,
      fill = taxa,
      col = taxa
    ),
  ) +
  ggplot2::geom_ribbon() +
  ggplot2::scale_y_continuous(trans = &quot;reverse&quot;) +
  ggplot2::scale_x_continuous(breaks = c(0, 1)) +
  ggplot2::facet_wrap(~taxa, nrow = 1) +
  ggplot2::theme(
    legend.position = &quot;none&quot;
  )</code></pre>
<p><img
src="step_by_step_guide_files/figure-html/vis_data_with_ages-1.png" /><!-- --></p>
</div>
</div>
<div id="estimation-rate-of-change" class="section level2">
<h2>Estimation Rate-of-Change</h2>
<p>Here we use the the prepared data to estimate the rate of vegetation
change. We will present several scenarios based on the available data.
For all scenarios wr will be using <code>chisq</code> dissimilarity
coeficient (works best for pollen data), and
<code>time_standardisation</code> == 500 (this means that all ROC values
are ‘change per 500 yr’).</p>
<div id="scenario---levels" class="section level3">
<h3>Scenario - levels</h3>
<p>“Classic” approach with individual levels.</p>
<pre class="r"><code>scenario_1 &lt;-
  RRatepol::fc_estimate_RoC(
    data_source_community = sel_counts_selected,
    data_source_age = sel_level_predicted,
    DC = &quot;chisq&quot;,
    time_standardisation = 500,
    Working_Units = &quot;levels&quot; # here is set to use individual levels
  )</code></pre>
<pre class="r"><code>RRatepol::fc_plot_RoC_sequence(data_source = scenario_1)</code></pre>
<p><img
src="step_by_step_guide_files/figure-html/roc_sc1_vis-1.png" /><!-- --></p>
</div>
<div id="scenario---levels---smoothing" class="section level3">
<h3>Scenario - levels - smoothing</h3>
<p>We will use the same setting as before but now add smoothing of the
pollen data before analyses. Specifically, we will add
<code>smooth_method</code> = “shep” (i.e. Shepard’s 5-term filter).</p>
<pre class="r"><code>scenario_2 &lt;-
  RRatepol::fc_estimate_RoC(
    data_source_community = sel_counts_selected,
    data_source_age = sel_level_predicted,
    DC = &quot;chisq&quot;,
    time_standardisation = 500,
    Working_Units = &quot;levels&quot;,
    smooth_method = &quot;shep&quot; # Shepard&#39;s 5-term filter
  )</code></pre>
<p>We see that the patern change only slightly but the absolute value
drop to half.</p>
<pre class="r"><code>RRatepol::fc_plot_RoC_sequence(data_source = scenario_2)</code></pre>
<p><img
src="step_by_step_guide_files/figure-html/roc_sc2_vis-1.png" /><!-- --></p>
</div>
<div id="scenario---levels---subsampling" class="section level3">
<h3>Scenario - levels - subsampling</h3>
<p>We will now add taxa- standardization by random sub-sampling to 150
pollen grains in each level. In order to do that we need to increase a
number of randomisations. This is again a toy example for a quick
computation and we would recommend increasing the
<em>set_randomisations</em> to 10.000 for any real estimation.</p>
<pre class="r"><code>set_randomisations &lt;- 100</code></pre>
<pre class="r"><code>scenario_3 &lt;-
  RRatepol::fc_estimate_RoC(
    data_source_community = sel_counts_selected,
    data_source_age = sel_level_predicted,
    DC = &quot;chisq&quot;,
    Working_Units = &quot;levels&quot;,
    time_standardisation = 500,
    smooth_method = &quot;shep&quot;,
    standardise = TRUE, # set the taxa standardisation
    N_individuals = 150, # set the number of pollen grains
    rand = set_randomisations
  )</code></pre>
<p>We will now also obtain a gray shadow, which is indicating
uncertainty</p>
<pre class="r"><code>RRatepol::fc_plot_RoC_sequence(data_source = scenario_3)</code></pre>
<p><img
src="step_by_step_guide_files/figure-html/roc_sc3_vis-1.png" /><!-- --></p>
</div>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
